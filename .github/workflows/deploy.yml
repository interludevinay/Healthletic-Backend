name: CI Build KIND Helm deploy Smoke tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  IMAGE_REPO: ${{ secrets.IMAGE_REPO }}  # e.g., vinay/healthletic-backend

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get semantic version
        id: version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.1.0")
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Building Docker image: $IMAGE"
          docker build -t $IMAGE .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v0.24.0
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}
          format: 'table'
          exit-code: 1
          vuln-type: 'os,library'

      - name: Push image to Docker Hub
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Pushing Docker image: $IMAGE"
          docker push $IMAGE

      - name: Setup kind cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.20.0

      - name: Load Docker image into KIND
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          kind load docker-image $IMAGE

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: List Helm chart directory
        run: |
          echo "Current directory: $(pwd)"
          ls -R ./helm/backend

      - name: Helm deploy
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Deploying Helm release with image: $IMAGE"
          helm upgrade --install healthletic-backend ./helm/backend --set image.repository=${{ env.IMAGE_REPO }} --set image.tag=${{ steps.version.outputs.version }} --namespace default --wait


      - name: Smoke test: wait for service
        run: |
          echo "Waiting for healthletic-backend service..."
          until kubectl get svc healthletic-backend; do
            echo "Service not ready yet, waiting 5s..."
            sleep 5
          done
          echo "Service is ready!"
