name: CI Build KIND Helm Deploy Smoke Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_REPO: ${{ secrets.IMAGE_REPO }}  # e.g., vinay/healthletic-backend

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ---------------------- CHECKOUT ----------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ---------------------- SETUP DOCKER BUILD ENV ----------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---------------------- LOGIN TO DOCKER HUB ----------------------
      - name: Log into Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ---------------------- SEMANTIC VERSIONING ----------------------
      - name: Get semantic version
        id: version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.1.0")
          echo "version=$TAG" >> $GITHUB_OUTPUT

      # ---------------------- BUILD DOCKER IMAGE ----------------------
      - name: Build Docker image
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Building Docker image: $IMAGE"
          docker build -t $IMAGE .

      # ---------------------- SCAN IMAGE WITH TRIVY ----------------------
      # - name: Scan Docker image with Trivy
      #   uses: aquasecurity/trivy-action@0.28.0
      #   with:
      #     image‑ref: ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}
      #     format: table
      #     exit‑code: 1
      #     vuln‑type: os,library


      # ---------------------- PUSH IMAGE TO DOCKER HUB ----------------------
      - name: Push Docker image
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Pushing Docker image: $IMAGE"
          docker push $IMAGE

      # ---------------------- SETUP KIND CLUSTER ----------------------
      - name: Setup KIND cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.20.0

      - name: Load Docker image into KIND
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          kind load docker-image $IMAGE

      # ---------------------- INSTALL KUBECTL & HELM ----------------------
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      # ---------------------- LIST HELM CHART ----------------------
      - name: List Helm chart directory
        run: |
          echo "Current directory: $(pwd)"
          ls -R ./helm/backend

      # ---------------------- HELM DEPLOY ----------------------
      - name: Helm deploy
        run: |
          IMAGE="${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo "Deploying Helm release with image: $IMAGE"
          helm upgrade --install healthletic-backend ./helm/backend --set image.repository=${{ env.IMAGE_REPO }} --set image.tag=${{ steps.version.outputs.version }} --namespace default --wait

      # ---------------------- SMOKE TEST ----------------------
      - name: Smoke test - wait for service
        run: |
          echo "Waiting for healthletic-backend service..."
          until kubectl get svc healthletic-backend; do
            echo "Service not ready yet, waiting 5s..."
            sleep 5
          done
          echo "Service is ready!"

